<!DOCTYPE html>
<html>

<head>
    <title>Comp 20 Assignment 2: The Private Car Service</title>
    <meta name="viewport" content="initial-scale=1.0" />
    <meta charset="utf-8" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9sQaGQMUn1TEZG3C11LjRlpQAppS4WGk"></script>
    <script>
        var myLat = 0;
        var myLng = 0;
        var me = new google.maps.LatLng(myLat, myLng);

        var myOptions = {
            zoom: 13,
            center: me,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };

        var map;
        var marker;
        var vehicles;

        function init() {
            map = new google.maps.Map(document.getElementById("map"), myOptions);
            getMyLocation();
        }

        function getMyLocation() {
            if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(function(position){
                    myLat = position.coords.latitude;
                    myLng = position.coords.longitude;
                    renderMap();
                })
            }
            else{
                alert("Your browser does not support geolocation.");
            }
        }

        function renderMap() {
            me = new google.maps.LatLng(myLat, myLng);
            map.panTo(me);
            marker = new google.maps.Marker({
                position: me,
                title: "Here I am!"
            });
            marker.setMap(map);
            loadData();
        }

        function loadData() {
            var request = new XMLHttpRequest();
            var url = "https://hans-moleman.herokuapp.com/rides";
            var param = "username=6VhhvcGj&lat=" + myLat + "&lng=" + myLng;
            request.open("POST", url, true);

            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

            request.onreadystatechange = function() {
                if (request.readyState == 4 && request.status == 200) {
                    vehicles = JSON.parse(request.responseText);
                    console.log(vehicles);
                    for (count = 0; count < vehicles.length; count++) {
                        var pos = new google.maps.LatLng(vehicles[count].lat, vehicles[count].lng);
                        
                        var mark;
                        if (vehicles[count].username = "WIENERMOBILE") mark = "wienermobile.png";
                        else mark = "car.png";

                        var vmarker = new google.maps.Marker({
                            position: pos,
                            icon: mark,
                            title: vehicles[count].username
                        })
                        vmarker.setMap(map);
                    }                    
                }
            }
            request.send(param);
        }
    </script>
</head>

<body onload="init()">
    <div id="map"></div>
</body>

</html>